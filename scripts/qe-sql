import argparse
import sys
from pyqe import set_configuration, get_configuration, send_workflowresult_to_sql
import json

def parse_arguments():
    parser = argparse.ArgumentParser(description='Process some integers.')
    subparsers = parser.add_subparsers(help='sub-command help')
    parser.set_defaults(func=None)

    config_parser = subparsers.add_parser('set-config',
        help='Configure SQL connection.',
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    config_parser.add_argument('user', type=str, help='the username')
    config_parser.add_argument('database', type=str, help='the database name')
    config_parser.add_argument('--url', type=str, default='localhost', help='the SQL server URL')
    config_parser.add_argument('--port', type=str, default='5432', help='the SQL server port')
    config_parser.add_argument('--password', type=str, default='', help='the password')
    config_parser.set_defaults(func=set_configuration_command)


    show_config_parser = subparsers.add_parser('show-config', help='Show SQL configuration.')
    show_config_parser.set_defaults(func=show_configuration_command)

    upload_parser = subparsers.add_parser('upload', help='Upload workflow result to SQL connection.')
    upload_parser.add_argument('file', type=str, help='the workflowresult JSON file to process')
    upload_parser.set_defaults(func=upload)

    args = parser.parse_args()

    if args.func is None:
        parser.print_help(sys.stderr)
        sys.exit(1)
    else:
        args.func(args)

def set_configuration_command(args):
    configuration = {
        'user': args.user,
        'database': args.database,
        'url': args.url,
        'port': args.port,
        'password': args.password
    }
    set_configuration(configuration)

def show_configuration_command(args):
    config = get_configuration()
    if config:
        print(json.dumps(config, indent=2))
    else:
        print('SQL connection not configured.')

def upload(args):
    config = get_configuration()
    if not config:
        print('SQL connection not configured. Run `qe-sql set-config` to configure.')
    with open(args.file) as f:
        workflowresult = json.load(f)
    send_workflowresult_to_sql(workflowresult)

if __name__ == '__main__':
    parse_arguments()
